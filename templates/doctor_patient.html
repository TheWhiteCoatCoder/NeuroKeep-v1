{% extends "base.html" %}
{% block title %}–ü–∞—Ü–∏–µ–Ω—Ç: {{ patient.name }}{% endblock %}
{% block content %}
<h1>{{ patient.name }}</h1>
<div class="card">
  <h2>–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</h2>
  {% for med in meds %}<p>{{ med.drug_name }} {{ med.dosage }}</p>{% endfor %}
</div>

<div class="card">
  <h2>–ê–î (30 –¥–Ω–µ–π)</h2>
  <canvas id="bp30Chart" height="150"></canvas>
  <a href="{{ url_for('export_csv', patient_id=patient.id) }}" class="btn-secondary">üì• CSV –≠–∫—Å–ø–æ—Ä—Ç</a>
</div>

<div class="card">
  <h2>–ü—Ä–∏–≤–µ—Ä–∂–µ–Ω–Ω–æ—Å—Ç—å (30 –¥–Ω–µ–π)</h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;">
    {% for day in adh_30 %}
    <div style="text-align:center;font-size:0.75rem;">
      <div style="width:14px;height:14px;border-radius:3px;margin:0 auto;
        background:{% if day.taken >= day.total and day.total > 0 %}#16A34A{% else %}#E2E8F0{% endif %};">
      </div>
      <span style="color:#64748B;">{{ day.date }}</span>
    </div>
    {% endfor %}
  </div>
</div>

<div class="card">
  <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
  <table class="table">
    <thead><tr><th>–í—Ä–µ–º—è</th><th>–°–æ–±—ã—Ç–∏–µ</th></tr></thead>
    <tbody>
      {% for ev in events %}
      <tr><td>{{ ev.timestamp.strftime('%d.%m %H:%M') }}</td><td>{{ ev.event_type }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const labels = {{ bp_30 | map(attribute='date') | list | tojson }};
const sys = {{ bp_30 | map(attribute='systolic') | list | tojson }};
new Chart(document.getElementById('bp30Chart'), {
  type: 'line',
  data: { labels: labels, datasets: [{ label: '–°–∏—Å—Ç.', data: sys, borderColor: 'red' }] },
  options: { responsive: true, scales: { y: { min: 60, max: 190 } } }
});
</script>
{% endblock %}
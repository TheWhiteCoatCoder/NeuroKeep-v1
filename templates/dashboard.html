{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}
{% block content %}
<div class="dashboard-header">
  <div>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.name }}!</h1>
    <p class="subtitle" style="margin-top:4px;font-size:0.9rem;">
      –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤ –∏ –¥–∏–Ω–∞–º–∏–∫—É –ê–î –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
    </p>
  </div>
  <div class="streak-box">üî• –°–µ—Ä–∏—è: {{ streak }} –¥–Ω–µ–π</div>
</div>

<div class="card">
  <h2>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞</h2>
  {% if meds|length == 0 %}
    <p class="stat-text">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö –ø—Ä–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ.</p>
  {% endif %}
  {% for med in meds %}
  <div class="medication-card {% if med.confirmed_today %}confirmed{% endif %}">
    <div class="med-info">
      <h3>{{ med.drug_name }} <span class="dosage">{{ med.dosage }}</span></h3>
      <p class="time">{{ med.window_start }}‚Äì{{ med.window_end }}</p>
      {% if med.confirmed_today %}
      <span class="badge-green">‚úÖ –ü—Ä–∏–Ω—è—Ç–æ</span>
      {% elif med.in_window %}
      <span class="badge-yellow">‚è≥ –í—Ä–µ–º—è –ø—Ä–∏—ë–º–∞</span>
      {% else %}
      <span class="badge-red">‚ùå –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
      {% endif %}
    </div>
    {% if not med.confirmed_today and med.in_window %}
    <div class="actions">
      <button onclick="confirmDose({{ med.id }})" class="btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      <button onclick="skipDose({{ med.id }})" class="btn-secondary">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<div class="card">
  <h2>–ü—Ä–∏–≤–µ—Ä–∂–µ–Ω–Ω–æ—Å—Ç—å (7 –¥–Ω–µ–π)</h2>
  <p class="stat-text">–î–Ω–∏ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø—Ä–∏—ë–º–æ–º: {{ adherence_pct }}%.</p>
  <canvas id="adherenceChart" height="100"></canvas>
</div>

<script>
const adherenceData = {
  labels: {{ adherence_data|map(attribute='date')|list|tojson }},
  datasets: [{
    label: '–ü—Ä–∏–Ω—è—Ç–æ',
    data: {{ adherence_data|map(attribute='taken')|list|tojson }},
    backgroundColor: 'rgba(37, 99, 235, 0.5)'
  },{
    label: '–í—Å–µ–≥–æ',
    data: {{ adherence_data|map(attribute='total')|list|tojson }},
    backgroundColor: 'rgba(226, 232, 240, 0.8)'
  }]
};
new Chart(document.getElementById('adherenceChart'), {
  type: 'bar',
  data: adherenceData,
  options: { responsive: true, scales: { y: { beginAtZero: true } } }
});
function confirmDose(medId) {
  fetch(`/confirm_dose/${medId}`, { method: 'POST' })
    .then(r => r.json()).then(data => { if(data.success) location.reload(); });
}
function skipDose(medId) {
  fetch(`/skip_dose/${medId}`, { method: 'POST' })
    .then(r => r.json()).then(data => { if(data.success) location.reload(); });
}
</script>
{% endblock %}